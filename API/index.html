<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>RTAPI 任务面板</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;padding:20px}
        label{display:inline-block;margin:4px 8px 4px 0}
        input,select,button{padding:4px 8px;font-size:14px}
        table{border-collapse:collapse;margin-top:12px;width:100%}
        th,td{border:1px solid #ddd;padding:6px;text-align:left;font-size:13px}
        th{background:#f2f2f2}
        #log div{margin:2px 0;white-space:pre-wrap;font-size:12px}
        .hide{display:none}
    </style>
</head>
<body>
<h1>RTAPI测试</h1>

<h2>提交任务</h2>

<label>任务类型：
    <select id="module">
        <option value="original_download">下载原版客户端</option>
        <option value="launch_game">启动游戏</option>
        <option value="classify_versions">分类版本列表</option>
    </select>
</label>
<label>版本号：<input id="ver" placeholder="留空=默认"></label>


<fieldset id="launch-fields" class="hide" style="border:1px solid #aaa;padding:8px;margin-top:8px">
    <legend>LauncherConfig</legend>
    <label>minecraft_path：<input id="minecraft_path" style="width:320px"
                                 value="C:/Users/smh20/.minecraftx"></label><br>
    <label>java_path：<input id="java_path" style="width:320px"
                            value="C:/Program Files/Java/jdk-17/bin/java.exe"></label><br>
    <label>wrapper_path：<input id="wrapper_path" style="width:320px"
                               value="C:/Users/smh20/Documents/Rust/java_launch_wrapper-1.4.3.jar"></label><br>
    <label>launcher_version：<input id="launcher_version" value="1.0.0"></label>
    <label>max_memory：<input id="max_memory" value="16384"></label>
    <label>version_type：<input id="version_type" value="NULL11034"></label><br><br>

    <label>玩家名：<input id="player" value="Player"></label>
    <label>Token：<input id="token" value="mc_token"></label>
    <label>UUID：<input id="uuid" value="uuid"></label>
</fieldset>

<button id="start">提交</button>
<button id="refresh">刷新任务列表</button>

<h2>任务列表</h2>
<table id="tbl">
    <thead><tr><th>ID</th><th>类型</th><th>状态</th><th>信息</th><th>操作</th></tr></thead>
    <tbody></tbody>
</table>

<h2>日志</h2>
<pre id="log"></pre>

<script>
    const $ = s => document.querySelector(s);
    const log = msg => {
        const d = document.createElement('div');
        d.textContent = msg;
        $('#log').appendChild(d);
    };


    $('#module').onchange = () =>
        $('#launch-fields').classList.toggle('hide', $('#module').value !== 'launch_game');

    // 提交任务
    $('#start').onclick = () => {
        const payload = { module: $('#module').value };
        const v = $('#ver').value.trim();
        if (v) payload.version = v;

        if (payload.module === 'launch_game') {
            Object.assign(payload, {
                minecraft_path: $('#minecraft_path').value.trim(),
                java_path:      $('#java_path').value.trim(),
                wrapper_path:   $('#wrapper_path').value.trim(),
                launcher_version: $('#launcher_version').value.trim(),
                max_memory:       $('#max_memory').value.trim(),
                version_type:     $('#version_type').value.trim(),
                player: $('#player').value.trim(),
                token:  $('#token').value.trim(),
                uuid:   $('#uuid').value.trim(),
            });
        }

        fetch('/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(r => r.json())
            .then(({ id }) => {
                log('提交成功: ' + id);
                addWS(id);
                refresh();
            })
            .catch(e => log('提交失败: ' + e));
    };

    // WebSocket日志
    function addWS(id) {
        const ws = new WebSocket(`ws://${location.host}/ws/${id}`);
        ws.onmessage = e => log(`[${id}] ${e.data}`);
    }

    // 刷新任务列表
    function refresh() {
        fetch('/tasks')
            .then(r => r.json())
            .then(arr => {
                const tb = $('#tbl tbody');
                tb.innerHTML = '';
                arr.forEach(({ id, module, state, info }) => {
                    const running = state === 'running' || state === 'queued';
                    tb.insertAdjacentHTML(
                        'beforeend',
                        `<tr><td>${id}</td><td>${module}</td><td>${state}</td><td>${info}</td>
                         <td><button data-id="${id}" ${running ? '' : 'disabled'}>取消</button></td></tr>`
                    );
                });
            });
    }
    $('#refresh').onclick = refresh;

    // 取消按钮
    $('#tbl').addEventListener('click', e => {
        if (e.target.tagName === 'BUTTON') {
            fetch('/interrupt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: e.target.dataset.id })
            }).then(() => {
                log('已请求取消 ' + e.target.dataset.id);
                refresh();
            });
        }
    });

    refresh();
</script>
</body>
</html>
